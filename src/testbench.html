<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTC App – Testbench</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --panel:#ffffff;
      --border:#d9dde3;
      --text:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%; margin:0; color:var(--text); background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    #app{height:100%; display:grid; grid-template-columns: 420px 1fr; gap:12px; padding:12px; box-sizing:border-box;}
    #nav{background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:auto;}
    #main{background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column;}
    header{padding:12px 12px 10px; border-bottom:1px solid var(--border);}
    header h1{font-size:16px; margin:0 0 8px;}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .controls label{font-size:12px; color:var(--muted)}
    .controls input{padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:13px; min-width:160px}
    .controls button{padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-size:13px}
    .controls button.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .hint{font-size:12px; color:var(--muted); padding:0 12px 10px}
    .section{border-top:1px solid var(--border)}
    .sec-head{padding:10px 12px; display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none}
    .sec-head:hover{background:#f3f4f6}
    .sec-title{font-weight:700; font-size:13px}
    .sec-meta{margin-left:auto; font-size:12px; color:var(--muted)}
    .sec-body{display:none; padding:10px 12px 12px}
    .sec-body.open{display:block}
    .desc{font-size:12px; color:#374151; margin:0 0 10px}
    .ex-list{display:flex; flex-direction:column; gap:8px}
    .ex{border:1px solid var(--border); border-radius:12px; padding:10px; background:#fafafa}
    .ex .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .ex .name{font-weight:700; font-size:12px}
    .ex code{font-family:var(--mono); font-size:12px; background:#fff; border:1px solid var(--border); padding:6px 8px; border-radius:10px; display:block; width:100%; overflow:auto; box-sizing:border-box}
    .ex .actions{display:flex; gap:8px; margin-top:8px}
    .ex a, .ex button.small{font-size:12px; padding:6px 8px; border:1px solid var(--border); border-radius:10px; background:#fff; text-decoration:none; color:var(--text); cursor:pointer}
    .ex button.small{font-family:inherit}
    .ex a:hover, .ex button.small:hover{border-color:#b8c0cb}
    #iframeBar{padding:10px 12px; border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    #currentUrl{font-family:var(--mono); font-size:12px; color:#111; background:#f3f4f6; border:1px solid var(--border); padding:6px 8px; border-radius:10px; flex:1; min-width:260px; overflow:auto; white-space:nowrap}
    #iframeBar a, #iframeBar button{font-size:12px; padding:6px 8px; border:1px solid var(--border); border-radius:10px; background:#fff; text-decoration:none; color:var(--text); cursor:pointer}
    #iframe{flex:1; width:100%; border:0}
    .warn{color:#b91c1c}
  </style>
</head>
<body>
  <div id="app">
    <aside id="nav">
      <header>
        <h1>Testbench</h1>
        <div class="controls">
          <div>
            <label for="root">root</label><br/>
            <input id="root" value="." placeholder="e.g. . or test3/a/2" />
          </div>
          <div>
            <label for="file">file</label><br/>
            <input id="file" value="" placeholder="e.g. IMG20260215155425.jpg" />
          </div>
          <button class="primary" id="apply">Apply inputs</button>
        </div>
      </header>
      <div class="hint">
        Click an example to load its URL in the iframe. Most endpoints are GET. POST examples (save) are shown as commands only.
      </div>

      <!-- UI pages -->
      <div class="section">
        <div class="sec-head" data-toggle="ui">
          <div class="sec-title">UI pages</div>
          <div class="sec-meta">browse + gallery</div>
        </div>
        <div class="sec-body open" data-body="ui">
          <p class="desc">Main entry points for humans.</p>
          <div class="ex-list">
            <div class="ex">
              <div class="row"><div class="name">Browse editor</div></div>
              <code data-tpl="iptc_browse_editor.php?root={root}&debug=1">iptc_browse_editor.php?root={root}&amp;debug=1</code>
              <div class="actions">
                <button class="small" data-load>Load</button>
                <a data-open target="_blank" rel="noopener">Open new tab</a>
              </div>
            </div>
            <div class="ex">
              <div class="row"><div class="name">Browse editor (auto-load file)</div></div>
              <code data-tpl="iptc_browse_editor.php?root={root}&debug=1&file={file}">iptc_browse_editor.php?root={root}&amp;debug=1&amp;file={file}</code>
              <div class="actions">
                <button class="small" data-load>Load</button>
                <a data-open target="_blank" rel="noopener">Open new tab</a>
              </div>
              <div class="desc warn" style="margin:8px 0 0">Requires file input to be set.</div>
            </div>
            <div class="ex">
              <div class="row"><div class="name">Gallery</div></div>
              <code data-tpl="gallery.php">gallery.php</code>
              <div class="actions">
                <button class="small" data-load>Load</button>
                <a data-open target="_blank" rel="noopener">Open new tab</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- API -->
      <div class="section">
        <div class="sec-head" data-toggle="api">
          <div class="sec-title">API (GET)</div>
          <div class="sec-meta">diag/tree/list/read/aliases/build</div>
        </div>
        <div class="sec-body" data-body="api">
          <p class="desc">JSON endpoints used by the UI. All accept <code>root</code>. Read also requires <code>file</code>.</p>
          <div class="ex-list">
            <div class="ex">
              <div class="row"><div class="name">diag</div></div>
              <code data-tpl="iptc_api.php?action=diag&root={root}">iptc_api.php?action=diag&amp;root={root}</code>
              <div class="actions"><button class="small" data-load>Load</button><a data-open target="_blank" rel="noopener">Open new tab</a></div>
            </div>
            <div class="ex">
              <div class="row"><div class="name">aliases</div></div>
              <code data-tpl="iptc_api.php?action=aliases">iptc_api.php?action=aliases</code>
              <div class="actions"><button class="small" data-load>Load</button><a data-open target="_blank" rel="noopener">Open new tab</a></div>
            </div>
            <div class="ex">
              <div class="row"><div class="name">tree</div></div>
              <code data-tpl="iptc_api.php?action=tree&root=.">iptc_api.php?action=tree&amp;root=.</code>
              <div class="actions"><button class="small" data-load>Load</button><a data-open target="_blank" rel="noopener">Open new tab</a></div>
              <p class="desc" style="margin:8px 0 0">Tree is always built from <code>root=.</code> and contains nested paths.</p>
            </div>
            <div class="ex">
              <div class="row"><div class="name">list</div></div>
              <code data-tpl="iptc_api.php?action=list&root={root}">iptc_api.php?action=list&amp;root={root}</code>
              <div class="actions"><button class="small" data-load>Load</button><a data-open target="_blank" rel="noopener">Open new tab</a></div>
            </div>
            <div class="ex">
              <div class="row"><div class="name">read</div></div>
              <code data-tpl="iptc_api.php?action=read&root={root}&file={file}">iptc_api.php?action=read&amp;root={root}&amp;file={file}</code>
              <div class="actions"><button class="small" data-load>Load</button><a data-open target="_blank" rel="noopener">Open new tab</a></div>
              <div class="desc warn" style="margin:8px 0 0">Requires file input to be set.</div>
            </div>
            <div class="ex">
              <div class="row"><div class="name">build_metadata</div></div>
              <code data-tpl="iptc_api.php?action=build_metadata&root={root}">iptc_api.php?action=build_metadata&amp;root={root}</code>
              <div class="actions"><button class="small" data-load>Load</button><a data-open target="_blank" rel="noopener">Open new tab</a></div>
            </div>
          </div>
        </div>
      </div>

      <!-- POST examples -->
      <div class="section">
        <div class="sec-head" data-toggle="post">
          <div class="sec-title">API (POST examples)</div>
          <div class="sec-meta">save core / save all</div>
        </div>
        <div class="sec-body" data-body="post">
          <p class="desc">These cannot be run in an iframe (POST). Use curl/PowerShell or a REST client.</p>
          <div class="ex-list">
            <div class="ex">
              <div class="row"><div class="name">save (core)</div></div>
              <code>curl -X POST "http://localhost:8080/iptc_api.php?action=save&root={root}" \
  -H "Content-Type: application/json" \
  -d '{"file":"{file}","mode":"core","iptc":{"IPTC:ObjectName":"My title","IPTC:Headline":"My headline"},"geo":{"lat":55.47,"lng":10.45,"bearing":180.0,"zoom":16}}'</code>
            </div>
            <div class="ex">
              <div class="row"><div class="name">save (all IPTC fields)</div></div>
              <code>curl -X POST "http://localhost:8080/iptc_api.php?action=save&root={root}" \
  -H "Content-Type: application/json" \
  -d '{"file":"{file}","mode":"all","iptc":{ "... all IPTC tags ...": "..." },"geo":{"lat":55.47,"lng":10.45,"bearing":180.0,"zoom":16}}'</code>
            </div>
          </div>
        </div>
      </div>

    </aside>

    <main id="main">
      <div id="iframeBar">
        <div id="currentUrl">Click an example on the left…</div>
        <a id="openTab" target="_blank" rel="noopener" href="#">Open new tab</a>
        <button id="reload">Reload</button>
      </div>
      <iframe id="iframe" title="Output"></iframe>
    </main>
  </div>

  <script>
    const els = {
      root: document.getElementById('root'),
      file: document.getElementById('file'),
      apply: document.getElementById('apply'),
      iframe: document.getElementById('iframe'),
      currentUrl: document.getElementById('currentUrl'),
      openTab: document.getElementById('openTab'),
      reload: document.getElementById('reload'),
    };

    function getVars(){
      const root = (els.root.value || '.').trim() || '.';
      const file = (els.file.value || '').trim();
      return {root, file};
    }

    function tpl(str){
      const {root, file} = getVars();
      return str
        .replaceAll('{root}', encodeURIComponent(root))
        .replaceAll('{file}', encodeURIComponent(file));
    }

    function setUrl(url){
      els.currentUrl.textContent = url;
      els.iframe.src = url;
      els.openTab.href = url;
    }

    // sections collapse
    document.querySelectorAll('[data-toggle]').forEach(h=>{
      h.addEventListener('click', ()=>{
        const key = h.getAttribute('data-toggle');
        const body = document.querySelector('[data-body="'+key+'"]');
        if(!body) return;
        body.classList.toggle('open');
      });
    });

    // resolve example URLs and wire buttons
    function refreshExamples(){
      document.querySelectorAll('code[data-tpl]').forEach(code=>{
        const raw = code.getAttribute('data-tpl');
        code.textContent = raw.replaceAll('&','&').replaceAll('<','<');
        code.dataset.url = tpl(raw);
      });

      document.querySelectorAll('.ex').forEach(ex=>{
        const code = ex.querySelector('code[data-tpl]');
        const url = code ? code.dataset.url : null;

        const btn = ex.querySelector('button[data-load]');
        const a = ex.querySelector('a[data-open]');
        if(btn){
          btn.onclick = ()=>{
            if(!url) return;
            if(url.includes('{file}') || (code && code.getAttribute('data-tpl')?.includes('{file}') && !getVars().file)){
              alert('Set the file input first.');
              return;
            }
            setUrl(url);
          };
        }
        if(a){
          a.href = url || '#';
          a.onclick = (ev)=>{
            if(!url){ ev.preventDefault(); return; }
            if(code && code.getAttribute('data-tpl')?.includes('{file}') && !getVars().file){
              ev.preventDefault();
              alert('Set the file input first.');
              return;
            }
          };
        }
      });
    }

    els.apply.addEventListener('click', refreshExamples);
    els.reload.addEventListener('click', ()=>{ if(els.iframe.src) els.iframe.contentWindow.location.reload(); });

    // initial: read root/file from URL if present
    const qs = new URLSearchParams(location.search);
    if(qs.get('root')) els.root.value = qs.get('root');
    if(qs.get('file')) els.file.value = qs.get('file');

    refreshExamples();
  </script>
</body>
</html>
